{% extends "../includes/user_base.html" %}
{% block content %}

<div class="container p-0">
    <!-- Messages -->
    {% if messages %}
    <div class="  mt-2">
        {% for message in messages %}
        <div class="alert 
            {% if message.tags == 'success' %}alert-success
            {% elif message.tags == 'error' %}alert-danger
            {% elif message.tags == 'warning' %}alert-warning
            {% else %}alert-info{% endif %}">
            {{ message }}
        </div>
        {% endfor %}
    </div>
    {% endif %}

    <!-- Event Header -->
    <div class="row mb-3" >
        <div class="col-2 d-none d-md-block">
        <img src="/media/{{ poster_image }}" class="hover-effect-target" alt="Event Poster" width="150">
        </div>
        <div class="ps-sm-3 pe-sm-4 col-10">
            <h6 class="alert-heading mb-2">{{ title }}</h6>
              {{ theater_name }}, {{ state }}, {{ street }}<br />
            <b>Date/Time:</b> {{ date }} @ {{ time }}
        </div>
    </div>

    <!-- Filter Form + Scan QR Button -->
    <div class="col-sm-12 mb-3">
        <form class="needs-validation" method="GET" novalidate>
            <div class="row">
                <div class="col-md-3 p-2 position-relative">
                    <input type="number" value="{{ ticket_no }}" name="ticket_no" class="form-control"
                        id="validationTooltipt01" placeholder="Ticket number" required>
                    <div class="valid-tooltip">Looks good!</div>
                </div>
                <div class="col-md-4 p-2  position-relative">
                    <input type="email" {% if email %} value="{{ email }}" {% endif %} name="email" class="form-control"
                        id="validationTooltipt02" placeholder="Email" required>
                </div>
                <div class="col-md-2 p-2  d-flex align-items-center">
                    <button type="submit" class="btn btn-danger btn-sm">
                        <i class="ci-filter"></i> Filter <i class="ci-chevron-right"></i>
                    </button>
                    <!-- Scan QR Button -->
                   
                </div>
            </div>
        </form>
    </div>

    <h5>Ticket Booked</h5>
<div class="table-responsive">
    <!-- Bookings Table -->
    <table class="table align-middle fs-sm mb-0">
        <thead>
            <tr>
                <th>Ticket No.</th>
                <th>Detail</th>
                
                <th>Adult</th>
          
                <th>Total Cost</th>
                <th>Payment</th>
                <th>Attended</th>
            </tr>
        </thead>
        <tbody class="product-list">
            {% for booking in bookings %}
            <tr>
                <td>{{ booking.id }}</td>
                <td>{{ booking.full_name }} <br/>{{ booking.phone }}<br/> {{ booking.email }}</td>
                <td>{{ booking.no_adult }} * ${{ booking.price_adult }}
               <!-- C:  {{ booking.no_child }} * ${{ booking.price_child }} -->
            </td>
          
              
                <td class="earning text-start">$ {{ booking.total_payment }}</td>
                <td>
                    {% if booking.payment_status %}
                    <i class="ci-check-circle text-success" data-bs-toggle="tooltip" data-bs-placement="top"
                        title="Payment done"></i>
                    {% else %}
                    <a href="/payment/{{ booking.id }}" target="_blank" class="btn btn-sm btn-primary mb-2"
                        data-bs-toggle="tooltip" data-bs-placement="top" title="Payment Pending">
                        <i class="ci-banned"></i>&nbsp;Pay
                    </a>
                    {% endif %}
                </td>
                <td>
                    {% if booking.attended %}
                    <button type="button" class="mb-2 btn btn-sm btn-success" data-bs-toggle="tooltip"
                        data-bs-placement="top" title="{{ booking.full_name }} has checked in">
                        <i class="ci-check-circle animate-target fs-base me-2 ms-n1"></i> Checked in
                    </button>
                    {% else %}
                    {% if booking.payment_status == False %}
                    Payment required
                    {% else %}
                    <button type="button" class="mb-2 btn btn-sm btn-warning checkInBtn"
                        data-bs-toggle="modal" data-bs-target="#checkInModal"
                        data-booking-id="{{ booking.id }}"
                        data-full-name="{{ booking.full_name }}"
                        data-check-in="{{ booking.attended }}">
                        <i class="ci-check-circle animate-target fs-base me-2 ms-n1"></i> Check In
                    </button>
                    {% endif %}
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    </div>
</div>

<!-- ===== CHECK-IN MODAL ===== -->
<div class="modal fade" id="checkInModal" tabindex="-1" aria-labelledby="checkInModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <form id="checkInForm" method="POST">
                {% csrf_token %}
                <div class="modal-header">
                    <h5 class="modal-title" id="checkInModalLabel">Check In</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Ticket Number</label>
                        <input type="text" class="form-control" id="ticketNumberDisplay" readonly>
                    </div>
                    <input type="hidden" name="booking_id" id="modalBookingId">
                    <div class="mb-3">
                        <label for="remarks" class="form-label">Remarks</label>
                        <textarea class="form-control" name="remarks" id="remarks" rows="3"
                            placeholder="Enter remarks...">Checked in</textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-danger btn-sm">Confirm Check In</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- ===== SCAN QR MODAL ===== -->
<div class="modal fade" id="scanQRModal" tabindex="-1" aria-labelledby="scanQRModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h6 class="modal-title" id="scanQRModalLabel">Scan Ticket QR Code</h6>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center">
                <div id="qr-reader" style="width: 100%; max-width: 300px; height: 350px; margin: auto;"></div>
                <p id="scanResult" class="mt-3 text-success fw-bold"></p>
            </div>
        </div>
    </div>
</div>
<!-- Floating Scan QR Button -->
<button type="button" 
        class="btn btn-danger btn-lf d-block d-md-none position-fixed end-0 bottom-0 m-3" 
        data-bs-toggle="modal"
        
        data-bs-target="#scanQRModal">
    <i class="ci-camera animate-target"></i>  
</button>


<!-- ===== SCRIPTS ===== -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html5-qrcode/2.3.8/html5-qrcode.min.js"></script>

<script>
document.addEventListener("DOMContentLoaded", function () {
 
    // ===== MODAL & ELEMENT REFERENCES =====
    const checkInModalEl = document.getElementById('checkInModal');
    const checkInModal = new bootstrap.Modal(checkInModalEl);
    const scanModalEl = document.getElementById('scanQRModal');
    const scanModal = new bootstrap.Modal(scanModalEl);

    const bookingIdInput = document.getElementById('modalBookingId');
    const ticketNumberDisplay = document.getElementById('ticketNumberDisplay');
    const modalTitle = document.getElementById('checkInModalLabel');
    const scanResultEl = document.getElementById('scanResult');

    let qrScanner;

    // ===== HANDLE MANUAL CHECK-IN BUTTON CLICK =====
    document.querySelectorAll('.checkInBtn').forEach(button => {
        button.addEventListener('click', function () {
            const bookingId = this.getAttribute('data-booking-id');
            const fullName = this.getAttribute('data-full-name');

            // Populate modal
            bookingIdInput.value = bookingId;
            ticketNumberDisplay.value = bookingId;
            modalTitle.textContent = "Check In - " + fullName;

            // Set form action (replace 'id' with actual event ID from context)
            const eventId = "{{ id }}";
            const type = "{{type}}";
            if (type == "event")
                document.getElementById("checkInForm").action = `/user/booking/tickets/e/${eventId}/`;
            else{
                document.getElementById("checkInForm").action = `/user/booking/tickets/${eventId}/`;
            }
        });
    });

    // ===== INITIALIZE QR SCANNER WHEN MODAL OPENS =====
    scanModalEl.addEventListener('shown.bs.modal', function () {
        if (!qrScanner) {
            qrScanner = new Html5Qrcode("qr-reader");
        }

        Html5Qrcode.getCameras().then(cameras => {
            if (cameras && cameras.length) {
                const backCamera = cameras.find(cam => cam.label.toLowerCase().includes("back")) || cameras[0];
                qrScanner.start(
                    backCamera.id,
                    { fps: 10, qrbox: 250 },
                    onScanSuccess,
                    onScanError
                ).catch(err => {
                    scanResultEl.innerText = "Camera error. Please retry.";
                    console.error("Scanner start error:", err);
                });
            } else {
                scanResultEl.innerText = "No camera found.";
            }
        }).catch(err => {
            scanResultEl.innerText = "Camera access denied.";
            console.error("Camera error:", err);
        });
    });

    // ===== STOP SCANNER WHEN MODAL CLOSES =====
    scanModalEl.addEventListener('hidden.bs.modal', function () {
        if (qrScanner && qrScanner.getState() !== Html5QrcodeScannerState.NOT_STARTED) {
            qrScanner.stop().then(() => {
                console.log("QR Scanner stopped.");
            }).catch(err => {
                console.error("Failed to stop scanner:", err);
            });
        }
    });

    // ===== HANDLE QR SCAN SUCCESS =====
    function onScanSuccess(decodedText, decodedResult) {
        const bookingId = decodedText.trim();

        if (!bookingId) {
            scanResultEl.innerText = "Invalid QR Code";
            return;
        }

        // Stop scanner
        qrScanner.stop().catch(console.error);

        // Close scan modal
        scanModal.hide();

        // Clear scan result
        scanResultEl.innerText = "";

        // Lookup booking in DOM to get full name
        const escapedId = CSS.escape(bookingId);
        const checkInBtn = document.querySelector(`.checkInBtn[data-booking-id='${escapedId}']`);
        let fullName = "Unknown Attendee";
        if (checkInBtn) {
            fullName = checkInBtn.getAttribute('data-full-name');
        }

        // Populate check-in modal
        bookingIdInput.value = bookingId;
        ticketNumberDisplay.value = bookingId;
        modalTitle.textContent = "Check In - " + fullName;

        // Set form action
        const eventId = "{{ id }}";
        const type = "{{type}}";
            if (type == "event")
                document.getElementById("checkInForm").action = `/user/booking/tickets/e/${eventId}/`;
            else{
                document.getElementById("checkInForm").action = `/user/booking/tickets/${eventId}/`;
            }

        // Show check-in modal after brief delay
        setTimeout(() => {
            checkInModal.show();
        }, 300);
    }

    // ===== HANDLE QR SCAN ERROR (optional) =====
    function onScanError(err) {
        // You can show minor errors or ignore
        console.warn("QR Scan Error:", err);
    }
});
</script>

{% endblock %}