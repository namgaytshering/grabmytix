{% extends "../includes/base.html" %}

{% block content %}
<!-- Page content -->
<main class="content-wrapper text-center py-4">
  <h2 class="mb-4">Scan your QR Code</h2>
  
  <!-- Camera Preview Area -->
  <div id="reader"></div>
  
  <!-- Result -->
  <p id="result" class="mt-3 text-success fw-bold"></p>
</main>

<!-- Load Html5Qrcode library -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html5-qrcode/2.3.8/html5-qrcode.min.js"></script>

<script>
  // Success callback
  function onScanSuccess(decodedText, decodedResult) {
    document.getElementById("result").innerText = "Scanned QR Code: " + decodedText;

    // Stop scanner after success
    html5Qrcode.stop().then(() => {
      console.log("Scanner stopped after success");
    }).catch((error) => {
      console.warn("Failed to stop scanner: ", error);
    });

    // Redirect if it's a ticket link
    if (decodedText.includes("ticket_number")) {
      alert("ss")
    }
  }

  // Error callback (optional)
  function onScanError(errorMessage) {
    // Ignore scanning errors (happens often when nothing is detected)
  }

  // Initialize scanner with back camera
  const html5Qrcode = new Html5Qrcode("reader");

  Html5Qrcode.getCameras().then(cameras => {
    if (cameras && cameras.length) {
      // Prefer back camera if available
      let backCamera = cameras.find(cam => cam.label.toLowerCase().includes("back")) || cameras[0];
      
      html5Qrcode.start(
        backCamera.id,
        { fps: 10, qrbox: 250 },
        onScanSuccess,
        onScanError
      ).catch(err => {
        console.error("Unable to start scanning:", err);
      });
    } else {
      alert("No cameras found on this device.");
    }
  }).catch(err => {
    console.error("Error getting cameras:", err);
  });
</script>

<style>
  #reader {
    width: 100%;
    max-width: 300px;
    height: 350px;
    margin: auto;
  }
</style>
{% endblock %}
